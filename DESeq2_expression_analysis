#####Differential gene expression analysis between levels of vagitype factor of the model while correcting for other maternal covariates


###load R packages
library(devEMF)
library(rnaseqGene)
library(DESeq2)
library(ggplot2)
library(dplyr)
library(pheatmap)
library(PoiClaClu)
library(RColorBrewer)
library(glmpca)
library(apeglm)
library(fission)
library(genefilter)
library(sva)
library(reshape)
library(gridExtra)
library(ggrepel)
library(tidyverse)
library(base)
library(vegan)
library(sparseLDA)
library(MASS)
library(plotly)
library(tidyr)
library(DescTools)
library(patchwork)
library(rcompanion)
library(ggrepel)
library(ggcorrplot)
library(magick)
library(enrichplot)
library(egg)
library(Maaslin2)
library(vegan)
library(clusterProfiler)
library(fgsea)
library(tibble)
library(DT)
library(variancePartition)
library(car)
library(FactoMineR)
library(readr)
library(stringr)
library(ggVennDiagram)
library(Rtsne)
library(ROCR)
library(pROC)
library(caret)
library(glmnet)
library(org.Hs.eg.db)


###load DESeq2 object
dds <- readRDS("dds.rds")
vsd <- vst(dds)

###Test for significant associations between covariates
df = as.data.frame(colData(dds))

by(df$age_scaled, df$Race, shapiro.test) #test for normality
by(df$age, df$Race, shapiro.test) #test for normality
kruskal.test(age_scaled ~ Race, data = df)
kruskal.test(age ~ Race, data = df)
pairwise.wilcox.test(df$age_scaled, df$Race, p.adjust.method = "bonferroni")
pairwise.wilcox.test(df$age, df$Race, p.adjust.method = "bonferroni")

by(df$ga_atSampling_weeks_scaled, df$Race, shapiro.test)
kruskal.test(df$ga_atSampling_weeks_scaled ~ Race, data = df)
kruskal.test(df$ga_atSampling_weeks ~ Race, data = df)
pairwise.wilcox.test(df$ga_atSampling_weeks_scaled, df$Race, p.adjust.method = "bonferroni")
pairwise.wilcox.test(df$ga_atSampling_weeks_scaled, df$Race, p.adjust.method = "bonferroni", alternative = "greater")
pairwise.wilcox.test(df$ga_atSampling_weeks, df$Race, p.adjust.method = "bonferroni")

by(df$ga_atSampling_weeks_scaled, df$vagitype, shapiro.test)
by(df$ga_atSampling_weeks, df$vagitype, shapiro.test)
kruskal.test(df$ga_atSampling_weeks_scaled ~ vagitype, data = df)
kruskal.test(df$ga_atSampling_weeks ~ vagitype, data = df)
pairwise.wilcox.test(df$ga_atSampling_weeks_scaled, df$vagitype, p.adjust.method = "bonferroni")
pairwise.wilcox.test(df$ga_atSampling_weeks_scaled, df$vagitype, p.adjust.method = "bonferroni", alternative = "greater")
pairwise.wilcox.test(df$ga_atSampling_weeks, df$vagitype, p.adjust.method = "bonferroni")


###Check for remaining outliers after DESeq2 object generation

# Extract Cook's distances
cooks_mat <- log10(assays(dds)[["cooks"]])  

# Compute upper threshold using the 1.5Ã— IQR rule
cooks_max <- apply(cooks_mat, 2, max, na.rm = TRUE)  # Max Cook's per sample
Q1 <- quantile(cooks_max, 0.25, na.rm = TRUE)  # First quartile (25th percentile)
Q3 <- quantile(cooks_max, 0.75, na.rm = TRUE)  # Third quartile (75th percentile)
IQR_value <- Q3 - Q1
upper_threshold <- Q3 + 1.5 * IQR_value  # Define outlier threshold

outlier_samples <- colnames(dds)[cooks_max > upper_threshold]
outlier_samples



###List pairwise contrasts for variable of interest 
contrasts <- list(
  "Non_Infectious_Medication_vs_No_medication" = list(factor = "Med_final", level1 = "Non_Infectious_Medication", level2 = "No_medication"),
  "Med_final_Progesterone_vs_No_medication" = list(factor = "Med_final", level1 = "Progesterone", level2 = "No_medication"),
  "White_vs_Black" = list(factor = "Race", level1 = "White", level2 = "Black"),
  "Hispanic_or_Latino_vs_Black" = list(factor = "Race", level1 = "Hispanic_or_Latino", level2 = "Black"),
  "Mixed_Race_vs_Black" = list(factor = "Race", level1 = "Mixed_Race", level2 = "Black"),
  "IncomeModified_Under_15_000_vs_Over15000" = list(factor = "IncomeModified", level1 = "Over15000", level2 = "Under_15_000"),
  "IncomeModified_Unknown_vs_Over15000" = list(factor = "IncomeModified", level1 = "Unknown", level2 = "Under_15_000"),
  "vagitype_Gardnerella.vaginalis_vs_Lactobacillus.crispatus_cluster" = list(factor = "vagitype", level1 = "Gardnerella vaginalis", level2 = "Lactobacillus crispatus_cluster"),
  "vagitype_Lactobacillus.gasseri_cluster_vs_Lactobacillus.crispatus_cluster" = list(factor = "vagitype", level1 = "Lactobacillus gasseri_cluster", level2 = "Lactobacillus crispatus_cluster"),
  "vagitype_Lactobacillus.iners_vs_Lactobacillus.crispatus_cluster" = list(factor = "vagitype", level1 = "Lactobacillus iners", level2 = "Lactobacillus crispatus_cluster"),
  "vagitype_Lachnocurva.vaginae_vs_Lactobacillus.crispatus_cluster" = list(factor = "vagitype", level1 = "Lachnocurva vaginae", level2 = "Lactobacillus crispatus_cluster"),
  "vagitype_No.type_vs_Lactobacillus.crispatus_cluster" = list(factor = "vagitype", level1 = "No type", level2 = "Lactobacillus crispatus_cluster")
)
contrasts_vagitype <- list(
  "vagitype_Gardnerella.vaginalis_vs_Lactobacillus.crispatus_cluster" = list(factor = "vagitype", level1 = "Gardnerella vaginalis", level2 = "Lactobacillus crispatus_cluster"),
  "vagitype_Lactobacillus.gasseri_cluster_vs_Lactobacillus.crispatus_cluster" = list(factor = "vagitype", level1 = "Lactobacillus gasseri_cluster", level2 = "Lactobacillus crispatus_cluster"),
  "vagitype_Lactobacillus.iners_vs_Lactobacillus.crispatus_cluster" = list(factor = "vagitype", level1 = "Lactobacillus iners", level2 = "Lactobacillus crispatus_cluster"),
  "vagitype_Lachnocurva.vaginae_vs_Lactobacillus.crispatus_cluster" = list(factor = "vagitype", level1 = "Lachnocurva vaginae", level2 = "Lactobacillus crispatus_cluster"),
  "vagitype_No.type_vs_Lactobacillus.crispatus_cluster" = list(factor = "vagitype", level1 = "No type", level2 = "Lactobacillus crispatus_cluster")
)





###Convert Ensembl IDs to gene names
res <- results(dds)

ens_ids <- gsub("\\..*", "", rownames(dds))
gene_symbols <- mapIds(
  org.Hs.eg.db,
  keys = ens_ids,
  column = "SYMBOL",
  keytype = "ENSEMBL",
  multiVals = "first"
)

###IDs without corresponding symbol remain Ensembl ID
gene_symbols[is.na(gene_symbols)] <- ens_ids[is.na(gene_symbols)]
names(gene_symbols) <- rownames(dds) # so you can index by rownames

results_list <- list()
sig_genes_list <- list()

for (name in names(contrasts)) {
  ct <- contrasts[[name]]
  res_df <- as.data.frame(results(dds, contrast = c(ct$factor, ct$level1, ct$level2)))
  ens <- gsub("\\..*", "", rownames(res_df))
  # Map to symbols, fallback to ID
  gene_out <- gene_symbols[rownames(res_df)]
  # Add as a column if you want it in the results table
  res_df$gene_name <- gene_out
  results_list[[name]] <- res_df
  # Significant genes: only gene_name (symbol or ID)
  sig_mask <- which(res_df$padj < 0.05 & abs(res_df$log2FoldChange) > 0 & res$baseMean > 10)
  sig_genes <- unique(res_df$gene_name[sig_mask])
  sig_genes_list[[name]] <- sig_genes
}

gene_symbols[is.na(gene_symbols)] <- ens_ids[is.na(gene_symbols)]
names(gene_symbols) <- rownames(vsd)



###View significant genes in each contrast
set.seed(455)
sig_summary <- map2_df(
  results_list,
  names(results_list),
  ~{
    res <- .x
    contrast <- .y
    # Significant genes: padj < 0.05 & abs(log2FC) > 0
    sig_genes <- rownames(res[which(res$padj < 0.05 & abs(res$log2FoldChange) > 0 & res$baseMean >= 10), ])
    if (length(sig_genes) == 0) return(NULL)
    tibble(
      Contrast = contrast,
      Gene = sig_genes,
      Direction = ifelse(res[sig_genes, "log2FoldChange"] > 0, "up", "down")
    )
  }
)

# Count number of significant up and down genes per contrast
sig_counts <- sig_summary %>%
  group_by(Contrast, Direction) %>%
  summarise(n_genes = n(), .groups = "drop") %>%
  tidyr::pivot_wider(names_from = Direction, values_from = n_genes, values_fill = 0)

sig_counts


###Heatmap of gene expression
anno <- as.data.frame(colData(dds)[, c("Med_final","ga_atSampling_weeks","Race", "IncomeModified","Birth_Status", "vagitype")]) #variables to keep in heatmap
rownames(anno) <- colnames(dds)
topVarGenes <- head(order(rowVars(assay(vsd)), decreasing = TRUE), 40) #select top 40 most variably expressed genes
mat <- assay(vsd)[topVarGenes, ]
mat <- mat - rowMeans(mat) #centering data
rownames(mat) <- gene_symbols[rownames(mat)]


#custom colors
c25 <- c(
  "Atopobium vaginae" = "#c49c94",
  "Granulicatella adiacens"  = "azure1",
  "Enterobacteriaceae cluster31" = "gray",
  "Gardnerella vaginalis" = "#d62728",
  "Lachnospiraceae BVAB1" = "#ff7f0e",
  "Lachnocurva vaginae" = "#ff7f0e",
  "Lactobacillus crispatus_cluster" = "#fff5aa",
  "Lactobacillus gasseri_cluster" = "#c5b0d5",
  "Lactobacillus iners" = "#aec7e8",
  "Lactobacillus jensenii" = "#ffbb78",
  "Lactobacillus delbrueckii" = "lightpink",
  "Mycoplasma hominis" = "#0ec434",
  "No type" = "black",
  "Prevotella cluster2" = "#17becf",
  "Prevotella cluster 2" = "#17becf",
  "Prevotella bivia" = "cornflowerblue",
  "TM7 OTU-H1" = "mediumvioletred",
  "Sneathia amnii" = "#9467bd",
  "Sneathia sanguinegens" = "#9467bd",
  "Staphylococcus cluster47" = "#9edae5",
  "Streptococcus agalactiae" = "tan4",
  "Streptococcus cluster29" = "cyan",
  "Streptococcus cluster 29" = "cyan",
  "Streptococcus cluster21" = "gray",
  "Streptococcus salivarius_thermophilus_vestibularis" = "gray",
  "NER" = "gray",
  "NonLactobacillus" = "red",
  "Lactobacillus" = "#fff5aa",
  "Lactobacillus_iners" = "#aec7e8",
  "LI_Above_med_Shannon" = "#aec7e8",
  "LI_Below_med_Shannon" = "darkblue",
  "Lactobacillus_Nonlactobacillus_split" = "magenta"
  
)


set3_colors_race <- colorRampPalette(brewer.pal(8, "Set2"))(length(unique(anno$Race)))
names(set3_colors_race) <- unique(anno$Race)
set4_colors_birth <- c("preterm" = "red", "term" = "blue")
size_factor_colors <- colorRampPalette(c("lightblue", "white", "orange"))(100)
size_factor_colors_2 <- colorRampPalette(c("lightblue", "gray", "darkblue"))(50)
set6_colors_med <- c("No_medication" = "honeydew3", "Non_Infectious_Medication" = "darkorchid", "Progesterone" = "deeppink4")
set7_colors_income <- c("Over15000" = "purple", "Under_15_000" = "pink", "Unknown" = "gray")

annotation_colors <- list(
  vagitype = c25,
  ga_atSampling_weeks = size_factor_colors_2,
  Race = set3_colors_race,
  Birth_Status = set4_colors_birth,
  Med_final = set6_colors_med,
  sizeFactor = size_factor_colors,
  IncomeModified = set7_colors_income
)

#Clustered heatmap
pheatmap(
  mat,
  annotation_col = anno,
  annotation_colors = annotation_colors,
  clustering_distance_rows = "euclidean",
  clustering_distance_cols = "correlation",
  clustering_method = "ward.D2",
  color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdBu")))(100),
  cluster_cols = TRUE,
  main = "Top Variable Genes Across All Samples",
  labels_col = rep("", ncol(mat), ##remove sample labels
  
))

ordered_samples <- order(anno$vagitype)
mat_ordered <- mat[, ordered_samples]
anno_ordered <- anno[ordered_samples, ]

#Heatmap sorted by vagitype and unclustered
full_heatmap = pheatmap(
  mat_ordered,
  annotation_col = anno_ordered,
  annotation_colors = annotation_colors,
  clustering_distance_rows = "euclidean",
  clustering_distance_cols = "correlation",
  clustering_method = "ward.D2",
  fontsize = 10,
  color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdBu")))(100),
  cluster_cols = FALSE,
  main = "Top Variable Genes Across All Samples",
  labels_col = rep("", ncol(mat_ordered)) 
)


#####PCoA analysis
factors_to_plot <- c("Med_final","systolic_scaled","age_scaled", "ga_atSampling_weeks_scaled", "Race", "IncomeModified", "vagitype") #variables of interest 
pcaData <- plotPCA(vsd, intgroup = factors_to_plot, returnData = TRUE)
percentVar <- round(100 * attr(pcaData, "percentVar"))
pcaData$name <- rownames(pcaData)

###PC1/PC2 ranges from all contrasts
all_pc1 <- c()
all_pc2 <- c()
for (name in names(contrasts)) {
  ct <- contrasts[[name]]
  sel_samples <- colnames(dds)[colData(dds)[[ct$factor]] %in% c(ct$level1, ct$level2)]
  if (length(sel_samples) < 3) next
  vsd_sub <- vsd[, sel_samples]
  pcaData_sub <- plotPCA(vsd_sub, intgroup = ct$factor, returnData = TRUE)
  all_pc1 <- c(all_pc1, pcaData_sub$PC1)
  all_pc2 <- c(all_pc2, pcaData_sub$PC2)
  
  ellipse_data <- pcaData_sub %>%
    group_by(!!sym(ct$factor)) %>%
    do({
      if (nrow(.) >= 3) {
        gb <- ggplot_build(
          ggplot(., aes_string(x = "PC1", y = "PC2", color = ct$factor)) +
            stat_ellipse(type = "norm")
        )
        # Only return if the ellipse exists
        if (length(gb$data) >= 2) gb$data[[2]] else tibble()
      } else {
        tibble() # return an empty tibble, NOT NULL
      }
    }) %>% ungroup()
  
  # Only add if there are x/y columns present
  if ("x" %in% names(ellipse_data) && "y" %in% names(ellipse_data)) {
    all_pc1 <- c(all_pc1, ellipse_data$x)
    all_pc2 <- c(all_pc2, ellipse_data$y)
  }
}
# Add 5% padding to avoid ellipses touching the edge
xpad <- 0.01 * diff(range(all_pc1, na.rm = TRUE))
ypad <- 0.01 * diff(range(all_pc2, na.rm = TRUE))
xlim_contrast <- range(all_pc1, na.rm = TRUE) + c(-xpad, xpad)
ylim_contrast <- range(all_pc2, na.rm = TRUE) + c(-ypad, ypad)

#Build PCA plots with consistent axes
pca_contrast_plot_list <- list()
for (name in names(contrasts)) {
  ct <- contrasts[[name]]
  factor_col <- ct$factor
  level1 <- ct$level1
  level2 <- ct$level2
  
  sel_samples <- colnames(dds)[colData(dds)[[factor_col]] %in% c(level1, level2)]
  if (length(sel_samples) < 3) next
  
  vsd_sub <- vsd[, sel_samples]
  pcaData <- plotPCA(vsd_sub, intgroup = factor_col, returnData = TRUE)
  percentVar <- round(100 * attr(pcaData, "percentVar"))
  
  p <- ggplot(pcaData, aes_string(x = "PC1", y = "PC2", color = factor_col)) +
    geom_point(size = 5, alpha = 0.8) +
    stat_ellipse(aes_string(group = factor_col, color = factor_col), type = "norm", linetype = 1, size = 1) +
    xlab(paste0("PC1: ", percentVar[1], "% variance")) +
    ylab(paste0("PC2: ", percentVar[2], "% variance")) +
    coord_cartesian(xlim = xlim_contrast, ylim = ylim_contrast) +
    theme(
      panel.background = element_rect(fill = "white", color = NA),
      panel.border = element_rect(fill = NA, color = "black", size = 1, linetype = "solid"),
      legend.background = element_rect(fill = "white", color = NA),
      legend.key = element_rect(fill = "white", color = NA),
      plot.title = element_text(size =30),
      axis.title.x = element_text(size = 30),
      axis.title.y = element_text(size = 30),
      legend.title = element_text(size =20),
      legend.text = element_text(size = 20),
      axis.text.x = element_text(size = 30),
      axis.text.y = element_text(size = 30),
      legend.key.height = unit(0.5, "lines")
    )
  
  
  pca_contrast_plot_list[[name]] <- p
}


#####Adonis test for PCoA plot
contrast_pvals <- c()
contrast_names <- c()
for (name in names(contrasts_vagitype)) {
  ct <- contrasts_vagitype[[name]]
  factor_col <- ct$factor
  level1 <- ct$level1
  level2 <- ct$level2
  
  sel_samples <- colnames(dds)[colData(dds)[[factor_col]] %in% c(level1, level2)]
  if (length(sel_samples) < 3) next
  
  vsd_sub <- vsd[, sel_samples]
  meta_sub <- as.data.frame(colData(vsd_sub))
  dist_mat_sub <- dist(t(assay(vsd_sub)), method = "euclidean")
  adonis_result <- adonis2(dist_mat_sub ~ get(factor_col), data = meta_sub)
  cat("Adonis test for", name, "\n")
  print(adonis_result)
  contrast_pvals <- c(contrast_pvals, adonis_result$`Pr(>F)`[1])
  contrast_names <- c(contrast_names, name)
}

# Adjust p-values for these subset tests
contrast_adj_pvals <- p.adjust(contrast_pvals, method = "BH")
result_table <- data.frame(Contrast = contrast_names,
                           p.value = contrast_pvals,
                           adj.p.value = contrast_adj_pvals)
print(result_table)


###################################################################
volcano_plot_list <- c()

for (i in seq_along(results_list)) {
  results_df <- results_list[[i]]
  results_df$gene <- results_df$gene_name
  
  ###filter genes w basemean > 10
  results_df <- results_df %>% filter(baseMean >= 10)
  
  # Add volcano plot categories
  results_df$category <- "Not_Significant"
  results_df$category[results_df$padj < 0.05 & results_df$log2FoldChange > 0] <- "Significant_Up"
  results_df$category[results_df$padj < 0.05 & results_df$log2FoldChange < 0] <- "Significant_Down"
  results_df$category <- factor(results_df$category, levels = c("Significant_Up", "Significant_Down", "Not_Significant"))
  
  # Identify top 20 up and down (among significant genes)
  top_up <- results_df %>%
    filter(category == "Significant_Up") %>%
    arrange(desc(log2FoldChange)) %>%
    slice_head(n = 20)
  top_down <- results_df %>%
    filter(category == "Significant_Down") %>%
    arrange(log2FoldChange) %>%
    slice_head(n = 20)
  top_genes <- bind_rows(top_up, top_down)$gene
  
  # Only label top genes
  results_df$label <- ifelse(results_df$gene %in% top_genes, results_df$gene, "")
  # Find symmetric x-axis limits
  max_abs_lfc <- max(abs(results_df$log2FoldChange), na.rm = TRUE)
  xlim_symmetric <- c(-max_abs_lfc, max_abs_lfc)
  min_padj <- min(results_df$padj[results_df$padj > 0], na.rm = TRUE)
  top_y <- -log10(min_padj)
  ylim_y <- c(0, top_y * 1.1)
  
  volcano_plot <- ggplot(results_df, aes(x = log2FoldChange, y = -log10(padj), color = category)) +
    geom_point(alpha = 0.6, size = 3) +
    geom_text_repel(
      aes(label = label),
      size = 5,
      max.overlaps = Inf,
      segment.size = 1
    ) +
    scale_color_manual(values = c("Significant_Up" = "red", "Significant_Down" = "blue", "Not_Significant" = "grey")) +
    geom_hline(yintercept = -log10(0.05), linetype = "dashed", color = "black") +
    labs(x = "Log2 Fold Change", y = "-log10(p-adj)", title = names(results_list)[i]) +
    xlim(xlim_symmetric) +
    ylim(ylim_y) +
    theme(
      panel.background = element_rect(fill = "white", color = NA),
      panel.border = element_rect(fill = NA, color = "black", size = 1, linetype = "solid"),
      legend.background = element_rect(fill = "white", color = NA),
      legend.key = element_rect(fill = "white", color = NA),
      plot.title = element_text(size = 30),
      axis.title.x = element_text(size = 20),
      axis.title.y = element_text(size = 20),
      legend.title = element_text(size = 15),
      legend.text = element_text(size = 15),
      axis.text.x = element_text(size = 20),
      axis.text.y = element_text(size = 20),
      legend.key.height = unit(0.5, "lines")
    )
  volcano_plot_list[[names(results_list)[i]]] <- volcano_plot
}

print(volcano_plot_list)


for (plot_name in names(volcano_plot_list)) {
  ggsave(
    filename = paste0(plot_name, ".svg"),
    plot = volcano_plot_list[[plot_name]],
    width = 1750,
    height = 1000,
    units = "mm",
    limitsize = FALSE
  )
}



#####Find commonly significantly differentially regulated genes and export tables
# Specify the contrast names for each vagitype group (as used in your contrasts/results_list)
dysbiosis_contrasts <- c(
  "vagitype_Gardnerella.vaginalis_vs_Lactobacillus.crispatus_cluster",
  "vagitype_Lachnocurva.vaginae_vs_Lactobacillus.crispatus_cluster",
  "vagitype_No.type_vs_Lactobacillus.crispatus_cluster"
)

extract_sig_genes <- function(df, direction = "up", lfc_thresh = 0, padj_thresh = 0.05, basemean_thresh = 10) {
  if (direction == "up") {
    sig <- df$padj < padj_thresh & df$log2FoldChange > lfc_thresh & df$baseMean > basemean_thresh
  } else {
    sig <- df$padj < padj_thresh & df$log2FoldChange < -lfc_thresh & df$baseMean > basemean_thresh
  }
  rownames(df)[which(sig)]
}

# Find common up/down genes among a group of contrasts
get_common_genes <- function(contrast_names, results_list, direction = "up") {
  sig_lists <- lapply(contrast_names, function(nm) {
    extract_sig_genes(results_list[[nm]], direction = direction)
  })
  Reduce(intersect, sig_lists)
}

common_dysbiosis_up <- get_common_genes(dysbiosis_contrasts, results_list, direction = "up")
common_dysbiosis_down <- get_common_genes(dysbiosis_contrasts, results_list, direction = "down")

# Optionally, get log2FC and padj averages for the common genes (across all contrasts)
get_gene_stats <- function(contrast_names, results_list, gene_list) {
  stats <- do.call(rbind, lapply(contrast_names, function(nm) {
    df <- results_list[[nm]]
    # Remove version if present in gene_list for subsetting
    gene_list_novers <- sub("\\..*", "", gene_list)
    rownames(df) <- sub("\\..*", "", rownames(df))
    df <- df[gene_list_novers, c("padj", "log2FoldChange"), drop = FALSE]
    df$ensembl_gene_id <- rownames(df)
    df$Contrast <- nm
    df
  }))
  aggregate(cbind(padj, log2FoldChange) ~ ensembl_gene_id, data = stats, FUN = mean)
}

# Save results with gene symbol annotation
if(length(common_dysbiosis_up) > 0) {
  dysbiosis_up_stats <- get_gene_stats(dysbiosis_contrasts, results_list, common_dysbiosis_up)
  # Add gene symbol column
  dysbiosis_up_stats$gene_symbol <- gene_symbols[dysbiosis_up_stats$ensembl_gene_id]
  write.csv(dysbiosis_up_stats, "common_dysbiosis_up_genes.csv", row.names = FALSE)
}
if(length(common_dysbiosis_down) > 0) {
  dysbiosis_down_stats <- get_gene_stats(dysbiosis_contrasts, results_list, common_dysbiosis_down)
  dysbiosis_down_stats$gene_symbol <- gene_symbols[dysbiosis_down_stats$ensembl_gene_id]
  write.csv(dysbiosis_down_stats, "common_dysbiosis_down_genes.csv", row.names = FALSE)
}

# Print the number of common genes for each
cat("Common upregulated dysbiosis genes:", length(common_dysbiosis_up), "\n")
cat("Common downregulated dysbiosis genes:", length(common_dysbiosis_down), "\n")




#####Export individual contrast tables
for (contrast_name in names(results_list)) {
  res_df <- results_list[[contrast_name]]
  if (is.null(res_df) || nrow(res_df) == 0) next
  
  # Filter for significant genes (padj < 0.05 and abs(log2FC) > 0)
  sig_df <- subset(res_df, !is.na(padj) & padj < 0.05 & abs(log2FoldChange) > 0 & baseMean > 10)
  
  # Only export if there are significant genes
  if (nrow(sig_df) > 0) {
    sig_df$gene <- rownames(sig_df)
    # Remove version if present for mapping
    sig_df$ensembl_id_noversion <- sub("\\..*", "", sig_df$gene)
    # Map Ensembl IDs to gene symbols from your precomputed vector
    sig_df$gene_symbol <- gene_symbols[sig_df$ensembl_id_noversion]
    out_file <- paste0("DE_genes_", gsub("[ .]", "_", contrast_name), ".csv")
    write.csv(sig_df, file = out_file, row.names = FALSE)
    message("Exported: ", out_file)
  } else {
    message("No significant genes for ", contrast_name)
  }
}




######Combine results from all contrasts for broad gene overview
combined_upregulated <- data.frame()
combined_downregulated <- data.frame()

for (contrast_name in names(results_list)) {
  res_df <- results_list[[contrast_name]]
  if (is.null(res_df) || nrow(res_df) == 0) next
  
  # Upregulated genes
  sig_up <- subset(res_df, !is.na(padj) & padj < 0.05 & log2FoldChange > 0 & baseMean > 10)
  if (nrow(sig_up) > 0) {
    sig_up$gene <- rownames(sig_up)
    # Remove version for mapping
    sig_up$ensembl_id_noversion <- sub("\\..*", "", sig_up$gene)
    sig_up$gene_symbol <- gene_symbols[sig_up$ensembl_id_noversion]
    sig_up$contrast <- contrast_name
    sig_up_short <- sig_up[, c("gene", "gene_symbol", "padj", "log2FoldChange", "contrast")]
    combined_upregulated <- rbind(combined_upregulated, sig_up_short)
  }
  
  # Downregulated genes
  sig_down <- subset(res_df, !is.na(padj) & padj < 0.05 & log2FoldChange < 0 & baseMean > 10)
  if (nrow(sig_down) > 0) {
    sig_down$gene <- rownames(sig_down)
    sig_down$ensembl_id_noversion <- sub("\\..*", "", sig_down$gene)
    sig_down$gene_symbol <- gene_symbols[sig_down$ensembl_id_noversion]
    sig_down$contrast <- contrast_name
    sig_down_short <- sig_down[, c("gene", "gene_symbol", "padj", "log2FoldChange", "contrast")]
    combined_downregulated <- rbind(combined_downregulated, sig_down_short)
  }
}

write.csv(combined_upregulated, "all_upregulated_genes_combined.csv", row.names = FALSE)
write.csv(combined_downregulated, "all_downregulated_genes_combined.csv", row.names = FALSE)





######variance partition analysis#####
form <- ~Med_final + systolic_scaled + age_scaled + Race + ga_atSampling_weeks_scaled +  IncomeModified + vagitype
vsd_data = assay(vsd)
metadata_df <- as.data.frame(colData(vsd))
varPart <- fitExtractVarPartModel(vsd_data, form, metadata_df)
vp <- sortCols(varPart)  #sort columns by the amount of variance explained
vp_sorted <- vp[order(vp$vagitype, decreasing = TRUE), ]
violin <- plotVarPart(vp)

# Compute Canonical Correlation Analysis (CCA) between all pairs of variables, returns absolute correlation value
C <- canCorPairs(form, metadata_df)

# Plot correlation matrix between all pairs of variables
plotCorrMatrix(C)
mat_cor <- as.matrix(C)

big_theme <- theme(
  plot.caption = element_text(size = 100),
  plot.tag = element_text(size = 100)
)

cormat_plot <- ggcorrplot(
  mat_cor,
  lab = TRUE,
  lab_col = "black",
  lab_size = 20   # Controls the matrix label font
) +
  theme(
    axis.text.x = element_text(size = 60, family = "Arial", angle = 45, hjust = 1),
    axis.text.y = element_text(size = 60, family = "Arial"),
    plot.title = element_text(size = 60, face = "bold", family = "Arial"),
    legend.position = "none",
  ) +  labs(tag = "B") + big_theme


violin <- plotVarPart(vp) +
  theme(
    axis.title.x = element_text(size = 60, family = "Arial"),
    axis.title.y = element_text(size = 60, family = "Arial"),
    axis.text.x = element_text(size = 60, family = "Arial"),
    axis.text.y = element_text(size = 60, family = "Arial"),
    legend.title = element_text(size = 60, family = "Arial"),
    legend.text = element_text(size = 60, family = "Arial"),
    plot.title = element_text(size = 60, face = "bold", family = "Arial"),
  ) +  labs(tag = "A") + big_theme

design <- "
ABC
ABC
"
combined_plot10 <- violin + cormat_plot
plot_layout(design = design)



big_theme3 <- theme(
  axis.text = element_text(size = 90),
  legend.text = element_text(size = 60),
  legend.title = element_text(size = 90),
  axis.title.y = element_text(size = 80),
  axis.title.x = element_text(size = 80),
  plot.title = element_text(size = 60),
  plot.caption = element_text(size = 80),
  plot.tag = element_text(size = 180)
)


allbacteria_plot <- (
  # Row 1
  (
    volcano_plot_list$vagitype_Gardnerella.vaginalis_vs_Lactobacillus.crispatus_cluster + 
      labs(tag = "A") + big_theme3 |
      pca_contrast_plot_list$vagitype_Gardnerella.vaginalis_vs_Lactobacillus.crispatus_cluster + 
      labs(tag = "B", caption = "*padj = ") + big_theme3 |
      volcano_plot_list$vagitype_No.type_vs_Lactobacillus.crispatus_cluster + 
      labs(tag = "C") + big_theme3 |
      pca_contrast_plot_list$vagitype_No.type_vs_Lactobacillus.crispatus_cluster + 
      labs(tag = "D", caption = "*padj = ") + big_theme3
  ) /
    # Row 2
    (
      volcano_plot_list$vagitype_Lachnocurva.vaginae_vs_Lactobacillus.crispatus_cluster + 
        labs(tag = "E") + big_theme3 |
        pca_contrast_plot_list$vagitype_Lachnocurva.vaginae_vs_Lactobacillus.crispatus_cluster + 
        labs(tag = "F", caption = "*padj = ") + big_theme3 |
        volcano_plot_list$vagitype_Lactobacillus.gasseri_cluster_vs_Lactobacillus.crispatus_cluster + 
        labs(tag = "G") + big_theme3 |
        pca_contrast_plot_list$vagitype_Lactobacillus.gasseri_cluster_vs_Lactobacillus.crispatus_cluster + 
        labs(tag = "H", caption = "padj = ") + big_theme3
    ) /
    # Row 3
    (
      volcano_plot_list$vagitype_Lactobacillus.iners_vs_Lactobacillus.crispatus_cluster + 
        labs(tag = "I") + big_theme3 |
        pca_contrast_plot_list$vagitype_Lactobacillus.iners_vs_Lactobacillus.crispatus_cluster + 
        labs(tag = "J", caption = "padj = ") + big_theme3 |
        plot_spacer() + big_theme3 |
        plot_spacer() + big_theme3
    )
)





#####Visualize log2fc of inflammatory genes BCL2A1, CXCL8(IL8), NCF2, and IL1B from DESeq2#####
head(res_df)
vagitype_contrasts <- c(
  "vagitype_Gardnerella.vaginalis_vs_Lactobacillus.crispatus_cluster",
  "vagitype_Lachnocurva.vaginae_vs_Lactobacillus.crispatus_cluster",
  "vagitype_No.type_vs_Lactobacillus.crispatus_cluster"
)

genes_of_interest <- c("IL1B", "CXCL8", "NCF2", "BCL2A1")

vagitype_results <- results_list[grep("^vagitype_", names(results_list))]

plot_log2fc_bar <- function(gene_of_interest, vagitype_results, c25) {
  log2fc_df <- data.frame(
    Contrast = character(),
    log2FoldChange = numeric(),
    lfcSE = numeric(),
    stringsAsFactors = FALSE
  )
  
  for (contrast_name in names(vagitype_results)) {
    res_df <- vagitype_results[[contrast_name]]
    # Find the Ensembl ID for the gene symbol
    ensembl_id <- rownames(res_df)[res_df$gene_name == gene_of_interest]
    if (length(ensembl_id) > 0) {
      log2fc <- res_df[ensembl_id, "log2FoldChange"]
      lfcse <- res_df[ensembl_id, "lfcSE"]
      log2fc_df <- rbind(log2fc_df, data.frame(
        Contrast = contrast_name,
        log2FoldChange = log2fc,
        lfcSE = lfcse
      ))
    }
  }
  
  # Make a nice label
  log2fc_df$CleanLabel <- log2fc_df$Contrast
  log2fc_df$CleanLabel <- gsub("^vagitype_", "", log2fc_df$CleanLabel)
  log2fc_df$CleanLabel <- gsub("_vs_Lactobacillus\\.crispatus_cluster$", "", log2fc_df$CleanLabel)
  log2fc_df$CleanLabel <- gsub("\\.", " ", log2fc_df$CleanLabel)
  log2fc_df$CleanLabel <- gsub("cluster(\\d+)", "cluster \\1", log2fc_df$CleanLabel)
  
  ggplot(log2fc_df, aes(x = CleanLabel, y = log2FoldChange, fill = CleanLabel)) +
    geom_col(width = 0.7) +
    geom_errorbar(aes(ymin = log2FoldChange - lfcSE, ymax = log2FoldChange + lfcSE), width = 0.2) +
    geom_hline(yintercept = 0, linetype = "dashed") +
    labs(title = paste("log2 Fold Change of", gene_of_interest),
         y = "log2 Fold Change", x = "Vagitype vs. L. crispatus cluster") +
    scale_fill_manual(values = c25) +
    theme_classic() +
    theme(
      legend.position = "none",
      axis.title = element_text(size = 30),
      axis.text.x = element_text(angle = 45, hjust = 1, size = 40),  # increase x axis text size
      axis.text.y = element_text(size = 30)                         # increase y axis text size
    )

}

bar_list <- list()
for (gene in genes_of_interest) {
  p <- plot_log2fc_bar(gene, vagitype_results, c25)
  print(p)  # Optional: show plot as you go
  bar_list[[gene]] <- p
}


plot13 <- (
  (bar_list$BCL2A1 + labs(tag = "A")) | (bar_list$CXCL8 + labs(tag = "B"))
) /
  (
    (bar_list$IL1B + labs(tag = "C"))  | (bar_list$NCF2 + labs(tag = "D"))
  )







######Commonly significantly regulated genes venn diagrams
venn_list <- lapply(dysbiosis_contrasts, function(nm) {
  ens_ids <- extract_sig_genes(results_list[[nm]], direction = "up")
  gene_symbols[ens_ids][!is.na(gene_symbols[ens_ids])]
})
names(venn_list) <- str_wrap(c(
  "Up in G. vaginalis vs. L. crispatus",
  "Up in L. vaginae vs. L. crispatus",
  "Up in No type vs. L. crispatus"
), width = 20)

venn_list_2 <- lapply(dysbiosis_contrasts, function(nm) {
  ens_ids <- extract_sig_genes(results_list[[nm]], direction = "down")
  gene_symbols[ens_ids][!is.na(gene_symbols[ens_ids])]
})
names(venn_list_2) <- str_wrap(c(
  "Down in G. vaginalis vs. L. crispatus",
  "Down in L. vaginae vs. L. crispatus",
  "Down in No type vs. L. crispatus"
), width = 20)


v1 <- ggVennDiagram(venn_list, 
                    label_color = "black",
                    label_geom = "text",
                    label_size = 10,
                    set_size = 6,
                    fontface = "bold",
                    set_fontface = "bold",
                    edge_size = 0.5)+
  scale_fill_gradient(low = "#F0F0F0", high = "darkgray")


v2 <- ggVennDiagram(venn_list_2, 
              label_color = "black",
              label_geom = "text",
              label_size = 10,
              set_size = 6,
              fontface = "bold",
              set_fontface = "bold",
              edge_size = 0.5)+
  scale_fill_gradient(low =  "#F0F0F0", high = "darkgray")

plot13 <- (
  v1 + 
    theme(
      legend.position = "none", 
      plot.margin = margin(r = 30, unit = "pt"),
      plot.tag = element_text(size = 25)  # shrink A label
    ) + 
    labs(tag = "A")
) |
  (
    v2 + 
      theme(
        legend.position = "none",
        plot.tag = element_text(size = 25)  # shrink B label
      ) + 
      labs(tag = "B")
  )

plot13 <- plot13 + plot_annotation(
  caption = "Significant Differentially Expressed Genes among Dysbiotic Vagitypes",
  theme = theme(
    plot.caption = element_text(hjust = 0.5, size = 15, margin = margin(t = 10))
  )
)


print(plot13)




#####Sampling date to delivery distance dotplot#####
meta <- as.data.frame(colData(dds))

meta$ga_difference <- abs(meta$ga_atDel_weeks - meta$ga_atSampling_weeks)
# order rows by ga_atSampling_weeks (largest first)
meta <- meta[order(meta$ga_atSampling_weeks, decreasing = TRUE, na.last = TRUE), ]

# numeric y-axis index; index 1 will be plotted at the top with scale_y_reverse()
meta$SampleIndex <- seq_len(nrow(meta))

samp_dists <- ggplot(meta) +
  geom_segment(aes(x = ga_atSampling_weeks, xend = ga_atDel_weeks,
                   y = SampleIndex, yend = SampleIndex), color = "gray", size = 0.5) +
  geom_point(aes(x = ga_atSampling_weeks, y = SampleIndex, color = "Sample"), size = 3) +
  geom_point(aes(x = ga_atDel_weeks, y = SampleIndex, color = "Delivery"), size = 3) +
  geom_vline(xintercept = 37, linetype = "dashed", color = "black", size = 1) +
  scale_color_manual(name = "Timepoint", values = c("Sample" = "black", "Delivery" = "red")) +
  labs(x = "Gestational Age at Sample Collection and Delivery (weeks)", y = "Sample",
       title = "") +
  theme_classic() +
  theme(
    panel.border = element_rect(colour = "black", fill = NA, size = 1),
    axis.line = element_line(colour = "black", size = 1),
    axis.text = element_text(size = 20),
    axis.text.x = element_text(size = 30),
    axis.text.y = element_text(size = 30),
    legend.text = element_text(size = 20),
    axis.title.x = element_text(size = 30),
    axis.title.y = element_text(size = 30),
    axis.ticks = element_line(colour = "black", size = 2),
    legend.background = element_rect(fill = "white", size = 0.5, linetype = "solid")
  ) +
  scale_x_continuous(breaks = c(13, 26, 37, 40)) +
  scale_y_reverse()  # index 1 (largest sampling GA) appears at the top

print(samp_dists)




#####Modifications for model when subsetting the data into only black women#####

contrasts <- list(
  "Non_Infectious_Medication_vs_No_medication" = list(factor = "Med_final", level1 = "Non_Infectious_Medication", level2 = "No_medication"),
  "Med_final_Progesterone_vs_No_medication" = list(factor = "Med_final", level1 = "Progesterone", level2 = "No_medication"),
  "IncomeModified_Under_15_000_vs_Over15000" = list(factor = "IncomeModified", level1 = "Over15000", level2 = "Under_15_000"),
  "IncomeModified_Unknown_vs_Over15000" = list(factor = "IncomeModified", level1 = "Unknown", level2 = "Under_15_000"),
  "vagitype_Gardnerella.vaginalis_vs_Lactobacillus.crispatus_cluster" = list(factor = "vagitype", level1 = "Gardnerella vaginalis", level2 = "Lactobacillus crispatus_cluster"),
  "vagitype_Lactobacillus.gasseri_cluster_vs_Lactobacillus.crispatus_cluster" = list(factor = "vagitype", level1 = "Lactobacillus gasseri_cluster", level2 = "Lactobacillus crispatus_cluster"),
  "vagitype_Lactobacillus.iners_vs_Lactobacillus.crispatus_cluster" = list(factor = "vagitype", level1 = "Lactobacillus iners", level2 = "Lactobacillus crispatus_cluster"),
  "vagitype_Lachnocurva.vaginae_vs_Lactobacillus.crispatus_cluster" = list(factor = "vagitype", level1 = "Lachnocurva vaginae", level2 = "Lactobacillus crispatus_cluster"),
  "vagitype_No.type_vs_Lactobacillus.crispatus_cluster" = list(factor = "vagitype", level1 = "No type", level2 = "Lactobacillus crispatus_cluster")
)
contrasts_vagitype <- list(
  "vagitype_Gardnerella.vaginalis_vs_Lactobacillus.crispatus_cluster" = list(factor = "vagitype", level1 = "Gardnerella vaginalis", level2 = "Lactobacillus crispatus_cluster"),
  "vagitype_Lactobacillus.gasseri_cluster_vs_Lactobacillus.crispatus_cluster" = list(factor = "vagitype", level1 = "Lactobacillus gasseri_cluster", level2 = "Lactobacillus crispatus_cluster"),
  "vagitype_Lactobacillus.iners_vs_Lactobacillus.crispatus_cluster" = list(factor = "vagitype", level1 = "Lactobacillus iners", level2 = "Lactobacillus crispatus_cluster"),
  "vagitype_Lachnocurva.vaginae_vs_Lactobacillus.crispatus_cluster" = list(factor = "vagitype", level1 = "Lachnocurva vaginae", level2 = "Lactobacillus crispatus_cluster"),
  "vagitype_No.type_vs_Lactobacillus.crispatus_cluster" = list(factor = "vagitype", level1 = "No type", level2 = "Lactobacillus crispatus_cluster")
)


anno <- as.data.frame(colData(dds)[, c("vagitype", "Med_final", "systolic_scaled", "age_scaled", "ga_atSampling_weeks_scaled", "IncomeModified")])


form <- ~Med_final + systolic_scaled + age_scaled + ga_atSampling_weeks_scaled + IncomeModified + vagitype
